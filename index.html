<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ãƒãƒ£ãƒ«ã‚ªãƒ•ã‚£ã‚¹ - éŸ³å£°é€šè©±å¯¾å¿œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            overflow: hidden;
            height: 100vh;
        }

        /* å…¥å®¤ç”»é¢ */
        .entry-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .entry-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 90%;
        }

        .entry-card h1 {
            font-size: 32px;
            color: #1e293b;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .entry-card p {
            color: #64748b;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .nickname-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .nickname-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .char-count {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 20px;
        }

        .join-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .join-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .join-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .mic-permission {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #0369a1;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚ªãƒ•ã‚£ã‚¹ç©ºé–“ */
        .office-container {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #f1f5f9;
        }

        /* ãƒˆãƒƒãƒ—ãƒãƒ¼ */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-header {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            position: relative;
        }

        .mic-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            background: #10b981;
            transition: all 0.2s;
        }

        .mic-indicator.muted {
            background: #ef4444;
        }

        .mic-indicator.speaking {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .user-details h3 {
            font-size: 14px;
            color: #1e293b;
            margin: 0;
        }

        .user-details p {
            font-size: 12px;
            color: #64748b;
            margin: 0;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .status-btn {
            background: #10b981;
            color: white;
        }

        .status-btn.away { background: #f59e0b; }
        .status-btn.meeting { background: #ef4444; }
        .status-btn.focus { background: #8b5cf6; }

        .mic-btn {
            background: #10b981;
            color: white;
            position: relative;
        }

        .mic-btn.muted {
            background: #ef4444;
        }

        .mic-btn.speaking {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        .volume-btn {
            background: #3b82f6;
            color: white;
        }

        .leave-btn {
            background: #64748b;
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* éŸ³å£°ãƒ¬ãƒ™ãƒ«è¡¨ç¤º */
        .audio-level {
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }

        .audio-level-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            border-radius: 2px;
            transition: width 0.1s ease;
            width: 0%;
        }

        /* ã‚ªãƒ•ã‚£ã‚¹ç©ºé–“ */
        .office-space {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
            background: #f8fafc;
            cursor: move;
        }

        .office-floor {
            width: 1400px;
            height: 900px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }

        /* ã‚ªãƒ•ã‚£ã‚¹å®¶å…· */
        .desk {
            position: absolute;
            background: #8b5cf6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .desk:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }

        .meeting-room {
            position: absolute;
            background: #ef4444;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
        }

        .meeting-room:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .lounge {
            position: absolute;
            background: #10b981;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }

        .lounge:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ */
        .user-avatar {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            cursor: pointer;
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .avatar-circle.my-avatar {
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 2px #f59e0b, 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            z-index: 21 !important;
        }

        .avatar-circle.speaking {
            animation: pulse 1s infinite;
            border-color: #f59e0b;
        }

        .status-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-available { background: #10b981; }
        .status-away { background: #f59e0b; }
        .status-meeting { background: #ef4444; }
        .status-focus { background: #8b5cf6; }

        .avatar-mic-indicator {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            background: #10b981;
            transition: all 0.2s;
        }

        .avatar-mic-indicator.muted {
            background: #ef4444;
        }

        .avatar-mic-indicator.speaking {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        .avatar-name {
            margin-top: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #1e293b;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 8px;
            border-radius: 8px;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* éŸ³å£°ç¯„å›²è¡¨ç¤º */
        .voice-range {
            position: absolute;
            border: 2px dashed #3b82f6;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .voice-range.active {
            opacity: 1;
        }

        /* å‚åŠ è€…ãƒªã‚¹ãƒˆ */
        .participants-panel {
            position: fixed;
            right: 20px;
            top: 90px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            max-height: 400px;
            overflow-y: auto;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .participant-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        .participant-item:hover {
            background: #f8fafc;
        }

        .participant-item:last-child {
            border-bottom: none;
        }

        .participant-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            position: relative;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
            margin: 0;
        }

        .participant-status {
            font-size: 12px;
            color: #64748b;
            margin: 0;
        }

        .participant-volume {
            width: 40px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 2px;
        }

        .participant-volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            border-radius: 2px;
            transition: width 0.1s ease;
            width: 0%;
        }

        /* éŸ³å£°è¨­å®šãƒ‘ãƒãƒ« */
        .audio-settings {
            position: fixed;
            top: 90px;
            left: 20px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            padding: 16px;
            display: none;
        }

        .audio-settings.show {
            display: block;
        }

        .audio-setting-item {
            margin-bottom: 16px;
        }

        .audio-setting-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .audio-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .audio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .audio-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }

        /* ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: white;
            color: #64748b;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .zoom-btn:hover {
            background: #f8fafc;
            color: #1e293b;
        }

        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            .participants-panel {
                position: fixed;
                bottom: 0;
                right: 0;
                left: 0;
                width: 100%;
                max-height: 40vh;
                border-radius: 12px 12px 0 0;
            }

            .audio-settings {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                border-radius: 12px 12px 0 0;
            }

            .office-floor {
                width: 120%;
                height: 120%;
            }

            .top-bar {
                padding: 0 15px;
            }

            .controls {
                gap: 5px;
            }

            .control-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes joinAnimation {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .user-avatar.joining {
            animation: joinAnimation 0.5s ease-out;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-content {
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>éŸ³å£°ãƒ‡ãƒã‚¤ã‚¹ã‚’æº–å‚™ä¸­...</p>
        </div>
    </div>

    <!-- å…¥å®¤ç”»é¢ -->
    <div class="entry-screen" id="entryScreen">
        <div class="entry-card">
            <h1>ğŸ¤ Virtual Office</h1>
            <p>éŸ³å£°é€šè©±å¯¾å¿œãƒãƒ¼ãƒãƒ£ãƒ«ã‚ªãƒ•ã‚£ã‚¹</p>
            <div class="mic-permission">
                ğŸ¤ ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
            </div>
            <input type="text" class="nickname-input" id="nicknameInput" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›" maxlength="10">
            <div class="char-count">
                <span id="charCount">0</span>/10æ–‡å­—
            </div>
            <button class="join-btn" id="joinBtn" disabled>ã‚ªãƒ•ã‚£ã‚¹ã«å‚åŠ </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚ªãƒ•ã‚£ã‚¹ç©ºé–“ -->
    <div class="office-container" id="officeContainer">
        <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
        <div class="top-bar">
            <div class="user-info">
                <div class="user-avatar-header" id="userAvatarHeader">
                    <div class="mic-indicator" id="micIndicator"></div>
                    <div class="audio-level">
                        <div class="audio-level-fill" id="audioLevelFill"></div>
                    </div>
                </div>
                <div class="user-details">
                    <h3 id="userNameHeader"></h3>
                    <p>éŸ³å£°é€šè©±å¯¾å¿œ</p>
                </div>
            </div>
            <div class="controls">
                <button class="control-btn status-btn" id="statusBtn">ğŸŸ¢ åœ¨å¸­</button>
                <button class="control-btn mic-btn" id="micBtn">ğŸ¤ ãƒã‚¤ã‚¯ON</button>
                <button class="control-btn volume-btn" id="volumeBtn">ğŸ”Š éŸ³é‡</button>
                <button class="control-btn leave-btn" id="leaveBtn">é€€å‡º</button>
            </div>
        </div>

        <!-- éŸ³å£°è¨­å®šãƒ‘ãƒãƒ« -->
        <div class="audio-settings" id="audioSettings">
            <div class="panel-header">ğŸ§ éŸ³å£°è¨­å®š</div>
            <div class="audio-setting-item">
                <label class="audio-setting-label">ãƒã‚¤ã‚¯æ„Ÿåº¦</label>
                <input type="range" class="audio-slider" id="micSensitivity" min="0" max="100" value="50">
            </div>
            <div class="audio-setting-item">
                <label class="audio-setting-label">ãƒã‚¹ã‚¿ãƒ¼ãƒœãƒªãƒ¥ãƒ¼ãƒ </label>
                <input type="range" class="audio-slider" id="masterVolume" min="0" max="100" value="50">
            </div>
            <div class="audio-setting-item">
                <label class="audio-setting-label">é€šè©±ç¯„å›² (ãƒ¡ãƒ¼ãƒˆãƒ«)</label>
                <input type="range" class="audio-slider" id="voiceRange" min="50" max="300" value="150">
            </div>
        </div>

        <!-- ã‚ªãƒ•ã‚£ã‚¹ç©ºé–“ -->
        <div class="office-space" id="officeSpace">
            <div class="office-floor" id="officeFloor">
                <!-- ãƒ‡ã‚¹ã‚¯ã‚¨ãƒªã‚¢ -->
                <div class="desk" style="top: 100px; left: 100px; width: 80px; height: 60px;">Desk 1</div>
                <div class="desk" style="top: 100px; left: 200px; width: 80px; height: 60px;">Desk 2</div>
                <div class="desk" style="top: 100px; left: 300px; width: 80px; height: 60px;">Desk 3</div>
                <div class="desk" style="top: 200px; left: 100px; width: 80px; height: 60px;">Desk 4</div>
                <div class="desk" style="top: 200px; left: 200px; width: 80px; height: 60px;">Desk 5</div>
                <div class="desk" style="top: 200px; left: 300px; width: 80px; height: 60px;">Desk 6</div>

                <!-- ä¼šè­°å®¤ -->
                <div class="meeting-room" style="top: 100px; right: 100px; width: 200px; height: 150px;">
                    ğŸ“‹ Meeting Room A
                </div>
                <div class="meeting-room" style="top: 300px; right: 100px; width: 200px; height: 150px;">
                    ğŸ’¼ Meeting Room B
                </div>

                <!-- ãƒ©ã‚¦ãƒ³ã‚¸ã‚¨ãƒªã‚¢ -->
                <div class="lounge" style="bottom: 100px; left: 100px; width: 300px; height: 120px;">
                    â˜• Coffee Lounge
                </div>

                <!-- éŸ³å£°ç¯„å›²è¡¨ç¤º -->
                <div class="voice-range" id="voiceRange"></div>
            </div>
        </div>

        <!-- å‚åŠ è€…ãƒ‘ãƒãƒ« -->
        <div class="participants-panel">
            <div class="panel-header">
                ğŸ¤ å‚åŠ è€… (<span id="participantCount">0</span>äºº)
            </div>
            <div id="participantsList"></div>
        </div>

        <!-- ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoomInBtn">+</button>
            <button class="zoom-btn" id="zoomOutBtn">-</button>
            <button class="zoom-btn" id="resetViewBtn">âŒ‚</button>
        </div>
    </div>

    <!-- éš ã‚ŒãŸéŸ³å£°è¦ç´  -->
    <div id="audioElements"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyABTIK8Xwj0fcdWL2T7Z2le9_UDoXdu10U",
            authDomain: "virtual-office-team.firebaseapp.com",
            databaseURL: "https://virtual-office-team-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "virtual-office-team",
            storageBucket: "virtual-office-team.firebasestorage.app",
            messagingSenderId: "904879677778",
            appId: "1:904879677778:web:ac4c511b383b02c4b35a8b"
        };

        // FirebaseåˆæœŸåŒ–
        let database = null;
        let isFirebaseEnabled = false;

        if (firebaseConfig.apiKey !== "your-api-key-here") {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseEnabled = true;
                console.log('Firebaseæ¥ç¶šæˆåŠŸ - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°é€šè©±ãŒåˆ©ç”¨å¯èƒ½');
            } catch (error) {
                console.log('Firebaseæ¥ç¶šå¤±æ•—ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œ:', error);
            }
        }

        // éŸ³å£°é–¢é€£ã®å¤‰æ•°
        let localStream = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;
        let isMicOn = false;
        let masterVolume = 0.5;
        let micSensitivity = 0.5;
        let voiceRangeDistance = 150;
        let isAudioInitialized = false;
        let peerConnections = {};
        let remoteStreams = {};

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let currentUser = null;
        let users = {};
        let currentStatus = 'available';
        let currentZoom = 1;
        let panX = 0;
        let panY = 0;

        // DOMè¦ç´ 
        const elements = {
            entryScreen: document.getElementById('entryScreen'),
            officeContainer: document.getElementById('officeContainer'),
            loadingScreen: document.getElementById('loadingScreen'),
            nicknameInput: document.getElementById('nicknameInput'),
            charCount: document.getElementById('charCount'),
            joinBtn: document.getElementById('joinBtn'),
            userAvatarHeader: document.getElementById('userAvatarHeader'),
            userNameHeader: document.getElementById('userNameHeader'),
            statusBtn: document.getElementById('statusBtn'),
            micBtn: document.getElementById('micBtn'),
            volumeBtn: document.getElementById('volumeBtn'),
            leaveBtn: document.getElementById('leaveBtn'),
            officeSpace: document.getElementById('officeSpace'),
            officeFloor: document.getElementById('officeFloor'),
            participantCount: document.getElementById('participantCount'),
            participantsList: document.getElementById('participantsList'),
            zoomInBtn: document.getElementById('zoomInBtn'),
            zoomOutBtn: document.getElementById('zoomOutBtn'),
            resetViewBtn: document.getElementById('resetViewBtn'),
            micIndicator: document.getElementById('micIndicator'),
            audioLevelFill: document.getElementById('audioLevelFill'),
            audioSettings: document.getElementById('audioSettings'),
            micSensitivity: document.getElementById('micSensitivity'),
            masterVolume: document.getElementById('masterVolume'),
            voiceRange: document.getElementById('voiceRange'),
            voiceRangeSlider: document.getElementById('voiceRange'),
            audioElements: document.getElementById('audioElements')
        };

        // éŸ³å£°åˆæœŸåŒ–
        async function initializeAudio() {
            try {
                showLoading();
                
                // ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    }
                });

                // éŸ³å£°åˆ†æã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(localStream);
                
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                microphone.connect(analyser);
                
                isMicOn = true;
                isAudioInitialized = true;
                
                console.log('éŸ³å£°ãƒ‡ãƒã‚¤ã‚¹åˆæœŸåŒ–æˆåŠŸ');
                showNotification('ğŸ¤ éŸ³å£°ãƒ‡ãƒã‚¤ã‚¹ãŒæº–å‚™ã§ãã¾ã—ãŸï¼');
                
                // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–é–‹å§‹
                startAudioLevelMonitoring();
                
                hideLoading();
                return true;
                
            } catch (error) {
                console.error('éŸ³å£°ãƒ‡ãƒã‚¤ã‚¹åˆæœŸåŒ–å¤±æ•—:', error);
                showNotification('âŒ ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                hideLoading();
                return false;
            }
        }

        // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–
        function startAudioLevelMonitoring() {
            if (!analyser || !dataArray) return;
            
            function updateAudioLevel() {
                analyser.getByteFrequencyData(dataArray);
                
                // éŸ³å£°ãƒ¬ãƒ™ãƒ«è¨ˆç®—
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                const average = sum / dataArray.length;
                const level = Math.min(100, (average / 255) * 100 * (micSensitivity * 2));
                
                // UIæ›´æ–°
                elements.audioLevelFill.style.width = level + '%';
                
                // è©±ã—ä¸­åˆ¤å®š
                const isSpeaking = level > 10;
                updateSpeakingState(isSpeaking);
                
                // è‡ªåˆ†ã®éŸ³å£°ãƒ¬ãƒ™ãƒ«ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é€ä¿¡
                if (currentUser && isFirebaseEnabled) {
                    database.ref(`users/${currentUser.id}`).update({
                        audioLevel: level,
                        isSpeaking: isSpeaking
                    });
                }
                
                requestAnimationFrame(updateAudioLevel);
            }
            
            updateAudioLevel();
        }

        // è©±ã—ä¸­çŠ¶æ…‹æ›´æ–°
        function updateSpeakingState(isSpeaking) {
            elements.micIndicator.classList.toggle('speaking', isSpeaking && isMicOn);
            elements.micBtn.classList.toggle('speaking', isSpeaking && isMicOn);
            
            const myAvatar = elements.officeFloor.querySelector(`[data-user-id="${currentUser?.id}"]`);
            if (myAvatar) {
                const circle = myAvatar.querySelector('.avatar-circle');
                const micIndicator = myAvatar.querySelector('.avatar-mic-indicator');
                if (circle) circle.classList.toggle('speaking', isSpeaking && isMicOn);
                if (micIndicator) micIndicator.classList.toggle('speaking', isSpeaking && isMicOn);
            }
        }

        // ç©ºé–“éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ 
        function calculateSpatialAudio(userId) {
            if (!users[userId] || !currentUser) return;
            
            const user = users[userId];
            const distance = Math.sqrt(
                Math.pow(user.x - currentUser.x, 2) + 
                Math.pow(user.y - currentUser.y, 2)
            );
            
            // è·é›¢ã«åŸºã¥ãéŸ³é‡èª¿æ•´
            const maxDistance = voiceRangeDistance;
            let volume = 0;
            
            if (distance < maxDistance) {
                volume = Math.pow(1 - (distance / maxDistance), 1.5);
            }
            
            const finalVolume = Math.max(0, Math.min(1, volume * masterVolume));
            
            // éŸ³å£°è¦ç´ ã®éŸ³é‡ã‚’èª¿æ•´
            const audioElement = document.getElementById(`audio-${userId}`);
            if (audioElement) {
                audioElement.volume = finalVolume;
            }
            
            return finalVolume;
        }

        // ãƒªãƒ¢ãƒ¼ãƒˆéŸ³å£°ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupRemoteAudio(userId, stream) {
            // æ—¢å­˜ã®éŸ³å£°è¦ç´ ã‚’å‰Šé™¤
            const existingAudio = document.getElementById(`audio-${userId}`);
            if (existingAudio) {
                existingAudio.remove();
            }
            
            // æ–°ã—ã„éŸ³å£°è¦ç´ ã‚’ä½œæˆ
            const audio = document.createElement('audio');
            audio.id = `audio-${userId}`;
            audio.srcObject = stream;
            audio.autoplay = true;
            audio.volume = masterVolume;
            
            elements.audioElements.appendChild(audio);
            
            // åˆæœŸéŸ³é‡è¨­å®š
            calculateSpatialAudio(userId);
            
            console.log(`${userId}ã®éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¨­å®šã—ã¾ã—ãŸ`);
        }

        // WebRTCæ¥ç¶šã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        async function setupWebRTC(remoteUserId) {
            if (!isFirebaseEnabled) return;
            
            const peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });
            
            peerConnections[remoteUserId] = peerConnection;
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒªãƒ¼ãƒ è¿½åŠ 
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡
            peerConnection.ontrack = (event) => {
                const remoteStream = event.streams[0];
                remoteStreams[remoteUserId] = remoteStream;
                setupRemoteAudio(remoteUserId, remoteStream);
                showNotification(`ğŸ¤ ${users[remoteUserId]?.nickname || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}ã¨éŸ³å£°æ¥ç¶šã—ã¾ã—ãŸ`);
            };
            
            // ICEå€™è£œã®å‡¦ç†
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    database.ref(`webrtc/${currentUser.id}/${remoteUserId}/candidates`).push({
                        candidate: event.candidate,
                        timestamp: Date.now()
                    });
                }
            };
            
            return peerConnection;
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getRandomColor() {
            const colors = [
                'linear-gradient(135deg, #3b82f6, #1d4ed8)',
                'linear-gradient(135deg, #10b981, #059669)',
                'linear-gradient(135deg, #f59e0b, #d97706)',
                'linear-gradient(135deg, #ef4444, #dc2626)',
                'linear-gradient(135deg, #8b5cf6, #7c3aed)',
                'linear-gradient(135deg, #06b6d4, #0891b2)'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›
            elements.nicknameInput.addEventListener('input', updateCharCount);
            elements.nicknameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !elements.joinBtn.disabled) {
                    joinOffice();
                }
            });

            // å‚åŠ ãƒœã‚¿ãƒ³
            elements.joinBtn.addEventListener('click', joinOffice);

            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            elements.statusBtn.addEventListener('click', toggleStatus);
            elements.micBtn.addEventListener('click', toggleMic);
            elements.volumeBtn.addEventListener('click', toggleAudioSettings);
            elements.leaveBtn.addEventListener('click', leaveOffice);

            // ã‚ªãƒ•ã‚£ã‚¹å†…ç§»å‹•
            elements.officeFloor.addEventListener('click', moveToPosition);

            // ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            elements.zoomInBtn.addEventListener('click', () => zoomOffice(1.2));
            elements.zoomOutBtn.addEventListener('click', () => zoomOffice(0.8));
            elements.resetViewBtn.addEventListener('click', resetView);

            // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ 
            elements.officeSpace.addEventListener('wheel', handleWheel);

            // éŸ³å£°è¨­å®š
            elements.micSensitivity.addEventListener('input', (e) => {
                micSensitivity = e.target.value / 100;
            });
            
            elements.masterVolume.addEventListener('input', (e) => {
                masterVolume = e.target.value / 100;
                updateAllAudioVolumes();
            });
            
            elements.voiceRangeSlider.addEventListener('input', (e) => {
                voiceRangeDistance = parseInt(e.target.value);
                updateVoiceRangeDisplay();
            });

            // ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³
            let isDragging = false;
            let lastX, lastY;

            elements.officeSpace.addEventListener('mousedown', (e) => {
                if (e.target === elements.officeSpace || e.target === elements.officeFloor) {
                    isDragging = true;
                    lastX = e.clientX;
                    lastY = e.clientY;
                    elements.officeSpace.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - lastX;
                    const deltaY = e.clientY - lastY;
                    panX += deltaX;
                    panY += deltaY;
                    updateTransform();
                    lastX = e.clientX;
                    lastY = e.clientY;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    elements.officeSpace.style.cursor = 'move';
                }
            });
        }

        // å…¨éŸ³å£°éŸ³é‡æ›´æ–°
        function updateAllAudioVolumes() {
            Object.keys(users).forEach(userId => {
                if (userId !== currentUser?.id) {
                    calculateSpatialAudio(userId);
                }
            });
        }

        // éŸ³å£°ç¯„å›²è¡¨ç¤ºæ›´æ–°
        function updateVoiceRangeDisplay() {
            if (!currentUser) return;
            
            const range = elements.voiceRange;
            const diameter = voiceRangeDistance * 2;
            
            range.style.width = diameter + 'px';
            range.style.height = diameter + 'px';
            range.style.left = (currentUser.x - voiceRangeDistance + 25) + 'px';
            range.style.top = (currentUser.y - voiceRangeDistance + 25) + 'px';
        }

        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
        function updateCharCount() {
            const length = elements.nicknameInput.value.length;
            elements.charCount.textContent = length;
            elements.joinBtn.disabled = length === 0 || length > 10;
        }

        // ã‚ªãƒ•ã‚£ã‚¹å‚åŠ 
        async function joinOffice() {
            const nickname = elements.nicknameInput.value.trim();
            if (!nickname || nickname.length > 10) {
                alert('åå‰ã¯1-10æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // éŸ³å£°åˆæœŸåŒ–
            const audioSuccess = await initializeAudio();
            if (!audioSuccess) {
                alert('éŸ³å£°ãƒ‡ãƒã‚¤ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒã‚¤ã‚¯ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä½œæˆ
                const userId = generateUserId();
                currentUser = {
                    id: userId,
                    nickname: nickname,
                    x: 400 + Math.random() * 200,
                    y: 200 + Math.random() * 200,
                    status: 'available',
                    micOn: true,
                    color: getRandomColor(),
                    joinedAt: Date.now(),
                    audioLevel: 0,
                    isSpeaking: false
                };

                console.log('Created current user:', currentUser);

                // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã®usersã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
                users[userId] = currentUser;
                console.log('Added to users object:', users);

                // Firebaseã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                if (isFirebaseEnabled) {
                    await database.ref(`users/${userId}`).set({
                        ...currentUser,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    showNotification('ğŸ‰ éŸ³å£°é€šè©±å¯¾å¿œãƒãƒ¼ãƒãƒ£ãƒ«ã‚ªãƒ•ã‚£ã‚¹ã«å‚åŠ ã—ã¾ã—ãŸï¼');
                } else {
                    addDemoUsers();
                    showNotification('ğŸ¯ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§éŸ³å£°é€šè©±ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™');
                }

                // ç”»é¢è¡¨ç¤º
                showOffice();
                
                // å³åº§ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
                updateUserDisplay();
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°é–‹å§‹
                startRealtimeUpdates();
                
                // éŸ³å£°ç¯„å›²è¡¨ç¤º
                updateVoiceRangeDisplay();

            } catch (error) {
                console.error('å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚ªãƒ•ã‚£ã‚¹ã¸ã®å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                hideLoading();
            }
        }

        // ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
        function addDemoUsers() {
            const demoUsers = [
                { nickname: 'AI Assistant', status: 'available', x: 300, y: 200 },
                { nickname: 'Team Lead', status: 'meeting', x: 800, y: 350 },
                { nickname: 'Designer', status: 'focus', x: 600, y: 500 }
            ];

            demoUsers.forEach((demo, index) => {
                const demoId = 'demo_' + index;
                users[demoId] = {
                    id: demoId,
                    nickname: demo.nickname,
                    x: demo.x,
                    y: demo.y,
                    status: demo.status,
                    micOn: Math.random() > 0.3,
                    color: getRandomColor(),
                    joinedAt: Date.now() - Math.random() * 60000,
                    audioLevel: Math.random() * 50,
                    isSpeaking: Math.random() > 0.7
                };
            });

            updateUserDisplay();
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°é–‹å§‹
        function startRealtimeUpdates() {
            if (isFirebaseEnabled) {
                const usersRef = database.ref('users');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç›£è¦–
                usersRef.on('value', (snapshot) => {
                    const newUsers = snapshot.val() || {};
                    const previousUsers = { ...users };
                    
                    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®WebRTCæ¥ç¶šé–‹å§‹
                    Object.keys(newUsers).forEach(userId => {
                        if (userId !== currentUser.id && !previousUsers[userId] && !peerConnections[userId]) {
                            console.log(`æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ãŒå‚åŠ ã—ã¾ã—ãŸ`);
                            setTimeout(() => {
                                setupWebRTC(userId);
                            }, 1000);
                        }
                    });
                    
                    // é€€å‡ºãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    Object.keys(previousUsers).forEach(userId => {
                        if (!newUsers[userId] && userId !== currentUser.id) {
                            console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ãŒé€€å‡ºã—ã¾ã—ãŸ`);
                            cleanupPeerConnection(userId);
                        }
                    });
                    
                    users = newUsers;
                    updateUserDisplay();
                    updateAllAudioVolumes();
                });

                // å®šæœŸçš„ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
                setInterval(() => {
                    if (currentUser) {
                        database.ref(`users/${currentUser.id}`).update({
                            lastActive: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                }, 30000);
            } else {
                // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ç”¨ã®éŸ³å£°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                setInterval(() => {
                    Object.keys(users).forEach(userId => {
                        if (userId !== currentUser?.id) {
                            users[userId].audioLevel = Math.random() * 30;
                            users[userId].isSpeaking = Math.random() > 0.8;
                        }
                    });
                    updateUserDisplay();
                }, 2000);
            }
        }

        // PeerConnection ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        function cleanupPeerConnection(userId) {
            if (peerConnections[userId]) {
                peerConnections[userId].close();
                delete peerConnections[userId];
            }
            if (remoteStreams[userId]) {
                delete remoteStreams[userId];
            }
            const audioElement = document.getElementById(`audio-${userId}`);
            if (audioElement) {
                audioElement.remove();
            }
            showNotification(`ğŸ‘‹ ${users[userId]?.nickname || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}ãŒé€€å‡ºã—ã¾ã—ãŸ`);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºæ›´æ–°
        function updateUserDisplay() {
            console.log('Updating user display. Current users:', Object.keys(users));
            console.log('Current user ID:', currentUser?.id);
            
            // æ—¢å­˜ã®ã‚¢ãƒã‚¿ãƒ¼ã‚’å‰Šé™¤
            const existingAvatars = elements.officeFloor.querySelectorAll('.user-avatar');
            console.log('Removing existing avatars:', existingAvatars.length);
            existingAvatars.forEach(avatar => avatar.remove());

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ä½œæˆ
            Object.values(users).forEach(user => {
                console.log('Creating avatar for:', user.nickname, 'ID:', user.id);
                createUserAvatar(user);
            });
            
            // è‡ªåˆ†ã®ã‚¢ãƒã‚¿ãƒ¼ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            const myAvatar = elements.officeFloor.querySelector(`[data-user-id="${currentUser?.id}"]`);
            console.log('My avatar after creation:', myAvatar);
            
            // å‚åŠ è€…ãƒªã‚¹ãƒˆæ›´æ–°
            updateParticipantsList();
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ä½œæˆ
        function createUserAvatar(user) {
            console.log('Creating avatar for user:', user);
            
            const avatar = document.createElement('div');
            avatar.className = 'user-avatar';
            if (user.id === currentUser?.id) {
                avatar.classList.add('joining');
                console.log('Creating MY avatar:', user.nickname);
            }
            
            // ä½ç½®ã‚’å®‰å…¨ãªç¯„å›²ã«è¨­å®š
            const safeX = Math.max(50, Math.min(user.x || 300, 1200));
            const safeY = Math.max(50, Math.min(user.y || 300, 700));
            
            avatar.style.left = safeX + 'px';
            avatar.style.top = safeY + 'px';
            avatar.style.zIndex = user.id === currentUser?.id ? '20' : '10';
            avatar.setAttribute('data-user-id', user.id);

            const circle = document.createElement('div');
            circle.className = 'avatar-circle';
            if (user.id === currentUser?.id) {
                circle.classList.add('my-avatar');
                console.log('Adding my-avatar class');
            }
            if (user.isSpeaking && user.micOn) {
                circle.classList.add('speaking');
            }
            circle.style.background = user.color || 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
            circle.textContent = user.nickname.charAt(0).toUpperCase();

            const statusIndicator = document.createElement('div');
            statusIndicator.className = `status-indicator status-${user.status || 'available'}`;

            const micIndicator = document.createElement('div');
            micIndicator.className = 'avatar-mic-indicator';
            if (!user.micOn) {
                micIndicator.classList.add('muted');
            }
            if (user.isSpeaking && user.micOn) {
                micIndicator.classList.add('speaking');
            }

            const name = document.createElement('div');
            name.className = 'avatar-name';
            name.textContent = user.nickname;

            circle.appendChild(statusIndicator);
            circle.appendChild(micIndicator);
            avatar.appendChild(circle);
            avatar.appendChild(name);

            elements.officeFloor.appendChild(avatar);
            
            console.log('Avatar created and added to DOM:', avatar);
        }

        // å‚åŠ è€…ãƒªã‚¹ãƒˆæ›´æ–°
        function updateParticipantsList() {
            const userCount = Object.keys(users).length;
            elements.participantCount.textContent = userCount;

            elements.participantsList.innerHTML = '';
            Object.values(users).forEach(user => {
                const item = document.createElement('div');
                item.className = 'participant-item';

                const avatar = document.createElement('div');
                avatar.className = 'participant-avatar';
                avatar.style.background = user.color;
                avatar.textContent = user.nickname.charAt(0).toUpperCase();

                const statusIndicator = document.createElement('div');
                statusIndicator.className = `status-indicator status-${user.status}`;
                avatar.appendChild(statusIndicator);

                const micIndicator = document.createElement('div');
                micIndicator.className = 'avatar-mic-indicator';
                if (!user.micOn) {
                    micIndicator.classList.add('muted');
                }
                if (user.isSpeaking && user.micOn) {
                    micIndicator.classList.add('speaking');
                }
                avatar.appendChild(micIndicator);

                const info = document.createElement('div');
                info.className = 'participant-info';

                const name = document.createElement('p');
                name.className = 'participant-name';
                name.textContent = user.nickname;

                const status = document.createElement('p');
                status.className = 'participant-status';
                status.textContent = getStatusText(user.status);

                const volumeBar = document.createElement('div');
                volumeBar.className = 'participant-volume';
                const volumeFill = document.createElement('div');
                volumeFill.className = 'participant-volume-fill';
                volumeFill.style.width = (user.audioLevel || 0) + '%';
                volumeBar.appendChild(volumeFill);

                info.appendChild(name);
                info.appendChild(status);
                info.appendChild(volumeBar);

                item.appendChild(avatar);
                item.appendChild(info);
                elements.participantsList.appendChild(item);
            });
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
        function getStatusText(status) {
            const statusMap = {
                available: 'åœ¨å¸­',
                away: 'é›¢å¸­',
                meeting: 'ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¸­',
                focus: 'é›†ä¸­ä¸­'
            };
            return statusMap[status] || 'åœ¨å¸­';
        }

        // ä½ç½®ç§»å‹•
        function moveToPosition(event) {
            if (!currentUser) return;

            const rect = elements.officeFloor.getBoundingClientRect();
            const x = (event.clientX - rect.left) / currentZoom - 25;
            const y = (event.clientY - rect.top) / currentZoom - 25;

            // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
            const maxX = elements.officeFloor.clientWidth - 50;
            const maxY = elements.officeFloor.clientHeight - 50;
            const finalX = Math.max(0, Math.min(x, maxX));
            const finalY = Math.max(0, Math.min(y, maxY));

            // currentUserã®ä½ç½®æ›´æ–°
            currentUser.x = finalX;
            currentUser.y = finalY;
            
            // usersã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚æ›´æ–°
            users[currentUser.id] = { ...currentUser };
            
            console.log('Moving to position:', finalX, finalY);

            // è‡ªåˆ†ã®ã‚¢ãƒã‚¿ãƒ¼æ›´æ–°
            const myAvatar = elements.officeFloor.querySelector(`[data-user-id="${currentUser.id}"]`);
            if (myAvatar) {
                myAvatar.style.left = finalX + 'px';
                myAvatar.style.top = finalY + 'px';
                console.log('Avatar moved to:', finalX, finalY);
            } else {
                console.log('My avatar not found, recreating...');
                // ã‚¢ãƒã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å†ä½œæˆ
                createUserAvatar(currentUser);
            }

            // éŸ³å£°ç¯„å›²è¡¨ç¤ºæ›´æ–°
            updateVoiceRangeDisplay();

            // ç©ºé–“éŸ³å£°æ›´æ–°
            updateAllAudioVolumes();

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
            if (isFirebaseEnabled) {
                database.ref(`users/${currentUser.id}`).update({
                    x: finalX,
                    y: finalY,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ‡ã‚Šæ›¿ãˆ
        function toggleStatus() {
            const statuses = ['available', 'away', 'meeting', 'focus'];
            const currentIndex = statuses.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % statuses.length;
            currentStatus = statuses[nextIndex];

            const statusEmojis = {
                available: 'ğŸŸ¢ åœ¨å¸­',
                away: 'ğŸŸ¡ é›¢å¸­',
                meeting: 'ğŸ”´ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¸­',
                focus: 'ğŸŸ£ é›†ä¸­ä¸­'
            };

            const statusClasses = {
                available: '',
                away: 'away',
                meeting: 'meeting',
                focus: 'focus'
            };

            elements.statusBtn.textContent = statusEmojis[currentStatus];
            elements.statusBtn.className = `control-btn status-btn ${statusClasses[currentStatus]}`;

            if (currentUser) {
                currentUser.status = currentStatus;
                updateUserStatus();
            }
        }

        // ãƒã‚¤ã‚¯åˆ‡ã‚Šæ›¿ãˆ
        function toggleMic() {
            isMicOn = !isMicOn;
            elements.micBtn.textContent = isMicOn ? 'ğŸ¤ ãƒã‚¤ã‚¯ON' : 'ğŸ”‡ ãƒã‚¤ã‚¯OFF';
            elements.micBtn.classList.toggle('muted', !isMicOn);
            elements.micIndicator.classList.toggle('muted', !isMicOn);

            // ãƒã‚¤ã‚¯ã®å®Ÿéš›ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = isMicOn;
                });
            }

            if (currentUser) {
                currentUser.micOn = isMicOn;
                updateUserStatus();
            }

            const action = isMicOn ? 'ON' : 'OFF';
            showNotification(`ğŸ¤ ãƒã‚¤ã‚¯ã‚’${action}ã«ã—ã¾ã—ãŸ`);
        }

        // éŸ³å£°è¨­å®šåˆ‡ã‚Šæ›¿ãˆ
        function toggleAudioSettings() {
            elements.audioSettings.classList.toggle('show');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateUserStatus() {
            if (isFirebaseEnabled && currentUser) {
                database.ref(`users/${currentUser.id}`).update({
                    status: currentUser.status,
                    micOn: currentUser.micOn,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
            } else if (currentUser) {
                users[currentUser.id] = { ...currentUser };
                updateUserDisplay();
            }
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½
        function zoomOffice(factor) {
            currentZoom = Math.max(0.5, Math.min(2, currentZoom * factor));
            updateTransform();
        }

        // ãƒ“ãƒ¥ãƒ¼ãƒªã‚»ãƒƒãƒˆ
        function resetView() {
            currentZoom = 1;
            panX = 0;
            panY = 0;
            updateTransform();
        }

        // å¤‰å½¢æ›´æ–°
        function updateTransform() {
            elements.officeFloor.style.transform = 
                `translate(calc(-50% + ${panX}px), calc(-50% + ${panY}px)) scale(${currentZoom})`;
        }

        // ãƒ›ã‚¤ãƒ¼ãƒ«å‡¦ç†
        function handleWheel(event) {
            event.preventDefault();
            const delta = event.deltaY > 0 ? 0.9 : 1.1;
            zoomOffice(delta);
        }

        // ã‚ªãƒ•ã‚£ã‚¹é€€å‡º
        async function leaveOffice() {
            if (confirm('ã‚ªãƒ•ã‚£ã‚¹ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
                // éŸ³å£°ãƒ‡ãƒã‚¤ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                
                // WebRTCæ¥ç¶šã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                Object.values(peerConnections).forEach(pc => pc.close());
                peerConnections = {};
                remoteStreams = {};
                
                // éŸ³å£°è¦ç´ ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                elements.audioElements.innerHTML = '';
                
                if (isFirebaseEnabled && currentUser) {
                    await database.ref(`users/${currentUser.id}`).remove();
                }
                
                currentUser = null;
                users = {};
                hideOffice();
                showEntry();
                
                showNotification('ğŸ‘‹ ã‚ªãƒ•ã‚£ã‚¹ã‹ã‚‰é€€å‡ºã—ã¾ã—ãŸ');
            }
        }

        // ç”»é¢è¡¨ç¤ºåˆ¶å¾¡
        function showLoading() {
            elements.loadingScreen.style.display = 'flex';
        }

        function hideLoading() {
            elements.loadingScreen.style.display = 'none';
        }

        function showEntry() {
            elements.entryScreen.classList.remove('hidden');
        }

        function showOffice() {
            hideLoading();
            elements.entryScreen.classList.add('hidden');
            elements.officeContainer.style.display = 'block';

            // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±è¨­å®š
            elements.userAvatarHeader.textContent = currentUser.nickname.charAt(0).toUpperCase();
            elements.userAvatarHeader.style.background = currentUser.color;
            elements.userNameHeader.textContent = currentUser.nickname;
            
            // éŸ³å£°ç¯„å›²è¡¨ç¤ºã‚’æœ‰åŠ¹åŒ–
            elements.voiceRange.classList.add('active');
        }

        function hideOffice() {
            elements.officeContainer.style.display = 'none';
            elements.audioSettings.classList.remove('show');
        }

        // åˆæœŸåŒ–
        function init() {
            setupEventListeners();
            
            // ä¿å­˜ã•ã‚ŒãŸåå‰ãŒã‚ã‚Œã°å¾©å…ƒ
            const savedName = localStorage.getItem('virtualOfficeNickname');
            if (savedName) {
                elements.nicknameInput.value = savedName;
                updateCharCount();
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«åå‰ã‚’ä¿å­˜
            elements.nicknameInput.addEventListener('input', () => {
                localStorage.setItem('virtualOfficeNickname', elements.nicknameInput.value);
            });

            // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
            if (!isFirebaseEnabled) {
                setTimeout(() => {
                    const demoNotice = document.createElement('div');
                    demoNotice.style.cssText = `
                        position: fixed; top: 20px; left: 20px;
                        background: #f59e0b; color: white;
                        padding: 8px 12px; border-radius: 6px;
                        font-size: 12px; z-index: 1001;
                    `;
                    demoNotice.textContent = 'ğŸ¯ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆéŸ³å£°ã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰';
                    document.body.appendChild(demoNotice);
                }, 1000);
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
