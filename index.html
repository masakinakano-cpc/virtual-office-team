<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éê„Éº„ÉÅ„É£„É´„Ç™„Éï„Ç£„Çπ - Èü≥Â£∞ÈÄöË©±ÂØæÂøú</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            overflow: hidden;
            height: 100vh;
        }

        /* ÂÖ•ÂÆ§ÁîªÈù¢ */
        .entry-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .entry-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 90%;
        }

        .entry-card h1 {
            font-size: 32px;
            color: #1e293b;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .entry-card p {
            color: #64748b;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .nickname-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .nickname-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .char-count {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 20px;
        }

        .join-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .join-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .join-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .mic-permission {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #0369a1;
        }

        /* „É°„Ç§„É≥„Ç™„Éï„Ç£„ÇπÁ©∫Èñì */
        .office-container {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #f1f5f9;
        }

        /* „Éà„ÉÉ„Éó„Éê„Éº */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-header {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            position: relative;
        }

        .mic-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            background: #10b981;
            transition: all 0.2s;
        }

        .mic-indicator.muted {
            background: #ef4444;
        }

        .mic-indicator.speaking {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .user-details h3 {
            font-size: 14px;
            color: #1e293b;
            margin: 0;
        }

        .user-details p {
            font-size: 12px;
            color: #64748b;
            margin: 0;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .status-btn {
            background: #10b981;
            color: white;
        }

        .status-btn.away { background: #f59e0b; }
        .status-btn.meeting { background: #ef4444; }
        .status-btn.focus { background: #8b5cf6; }

        .mic-btn {
            background: #10b981;
            color: white;
            position: relative;
        }

        .mic-btn.muted {
            background: #ef4444;
        }

        .mic-btn.speaking {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        .volume-btn {
            background: #3b82f6;
            color: white;
        }

        .leave-btn {
            background: #64748b;
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Èü≥Â£∞„É¨„Éô„É´Ë°®Á§∫ */
        .audio-level {
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }

        .audio-level-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            border-radius: 2px;
            transition: width 0.1s ease;
            width: 0%;
        }

        /* „Ç™„Éï„Ç£„ÇπÁ©∫Èñì */
        .office-space {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
            background: #f8fafc;
            cursor: move;
        }

        .office-floor {
            width: 1400px;
            height: 900px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }

        /* „Ç™„Éï„Ç£„ÇπÂÆ∂ÂÖ∑ */
        .desk {
            position: absolute;
            background: #8b5cf6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .desk:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }

        .meeting-room {
            position: absolute;
            background: #ef4444;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
        }

        .meeting-room:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .lounge {
            position: absolute;
            background: #10b981;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }

        .lounge:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        /* „É¶„Éº„Ç∂„Éº„Ç¢„Éê„Çø„Éº */
        .user-avatar {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            cursor: pointer;
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .avatar-circle.my-avatar {
            border-color: #f59e0b;
            box-shadow: 0 0 0 2px #f59e0b, 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .avatar-circle.speaking {
            animation: pulse 1s infinite;
            border-color: #f59e0b;
        }

        .status-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-available { background: #10b981; }
        .status-away { background: #f59e0b; }
        .status-meeting { background: #ef4444; }
        .status-focus { background: #8b5cf6; }

        .avatar-mic-indicator {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            background: #10b981;
            transition: all 0.2s;
        }

        .avatar-mic-indicator.muted {
            background: #ef4444;
        }

        .avatar-mic-indicator.speaking {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        .avatar-name {
            margin-top: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #1e293b;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 8px;
            border-radius: 8px;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Èü≥Â£∞ÁØÑÂõ≤Ë°®Á§∫ */
        .voice-range {
            position: absolute;
            border: 2px dashed #3b82f6;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .voice-range.active {
            opacity: 1;
        }

        /* ÂèÇÂä†ËÄÖ„É™„Çπ„Éà */
        .participants-panel {
            position: fixed;
            right: 20px;
            top: 90px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            max-height: 400px;
            overflow-y: auto;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .participant-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        .participant-item:hover {
            background: #f8fafc;
        }

        .participant-item:last-child {
            border-bottom: none;
        }

        .participant-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            position: relative;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
            margin: 0;
        }

        .participant-status {
            font-size: 12px;
            color: #64748b;
            margin: 0;
        }

        .participant-volume {
            width: 40px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 2px;
        }

        .participant-volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            border-radius: 2px;
            transition: width 0.1s ease;
            width: 0%;
        }

        /* Èü≥Â£∞Ë®≠ÂÆö„Éë„Éç„É´ */
        .audio-settings {
            position: fixed;
            top: 90px;
            left: 20px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            padding: 16px;
            display: none;
        }

        .audio-settings.show {
            display: block;
        }

        .audio-setting-item {
            margin-bottom: 16px;
        }

        .audio-setting-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .audio-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .audio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .audio-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }

        /* „Ç∫„Éº„É†„Éª„Éë„É≥„Ç≥„É≥„Éà„É≠„Éº„É´ */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: white;
            color: #64748b;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .zoom-btn:hover {
            background: #f8fafc;
            color: #1e293b;
        }

        /* ÈÄöÁü• */
        .notification {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* „É¢„Éê„Ç§„É´ÂØæÂøú */
        @media (max-width: 768px) {
            .participants-panel {
                position: fixed;
                bottom: 0;
                right: 0;
                left: 0;
                width: 100%;
                max-height: 40vh;
                border-radius: 12px 12px 0 0;
            }

            .audio-settings {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                border-radius: 12px 12px 0 0;
            }

            .office-floor {
                width: 120%;
                height: 120%;
            }

            .top-bar {
                padding: 0 15px;
            }

            .controls {
                gap: 5px;
            }

            .control-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes joinAnimation {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .user-avatar.joining {
            animation: joinAnimation 0.5s ease-out;
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-content {
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Èü≥Â£∞„Éá„Éê„Ç§„Çπ„ÇíÊ∫ñÂÇô‰∏≠...</p>
        </div>
    </div>

    <!-- ÂÖ•ÂÆ§ÁîªÈù¢ -->
    <div class="entry-screen" id="entryScreen">
        <div class="entry-card">
            <h1>üé§ Virtual Office</h1>
            <p>Èü≥Â£∞ÈÄöË©±ÂØæÂøú„Éê„Éº„ÉÅ„É£„É´„Ç™„Éï„Ç£„Çπ</p>
            <div class="mic-permission">
                üé§ „Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®±ÂèØ„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            </div>
            <input type="text" class="nickname-input" id="nicknameInput" placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ" maxlength="10">
            <div class="char-count">
                <span id="charCount">0</span>/10ÊñáÂ≠ó
            </div>
            <button class="join-btn" id="joinBtn" disabled>„Ç™„Éï„Ç£„Çπ„Å´ÂèÇÂä†</button>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç™„Éï„Ç£„ÇπÁ©∫Èñì -->
    <div class="office-container" id="officeContainer">
        <!-- „Éà„ÉÉ„Éó„Éê„Éº -->
        <div class="top-bar">
            <div class="user-info">
                <div class="user-avatar-header" id="userAvatarHeader">
                    <div class="mic-indicator" id="micIndicator"></div>
                    <div class="audio-level">
                        <div class="audio-level-fill" id="audioLevelFill"></div>
                    </div>
                </div>
                <div class="user-details">
                    <h3 id="userNameHeader"></h3>
                    <p>Èü≥Â£∞ÈÄöË©±ÂØæÂøú</p>
                </div>
            </div>
            <div class="controls">
                <button class="control-btn status-btn" id="statusBtn">üü¢ Âú®Â∏≠</button>
                <button class="control-btn mic-btn" id="micBtn">üé§ „Éû„Ç§„ÇØON</button>
                <button class="control-btn volume-btn" id="volumeBtn">üîä Èü≥Èáè</button>
                <button class="control-btn leave-btn" id="leaveBtn">ÈÄÄÂá∫</button>
            </div>
        </div>

        <!-- Èü≥Â£∞Ë®≠ÂÆö„Éë„Éç„É´ -->
        <div class="audio-settings" id="audioSettings">
            <div class="panel-header">üéß Èü≥Â£∞Ë®≠ÂÆö</div>
            <div class="audio-setting-item">
                <label class="audio-setting-label">„Éû„Ç§„ÇØÊÑüÂ∫¶</label>
                <input type="range" class="audio-slider" id="micSensitivity" min="0" max="100" value="50">
            </div>
            <div class="audio-setting-item">
                <label class="audio-setting-label">„Éû„Çπ„Çø„Éº„Éú„É™„É•„Éº„É†</label>
                <input type="range" class="audio-slider" id="masterVolume" min="0" max="100" value="50">
            </div>
            <div class="audio-setting-item">
                <label class="audio-setting-label">ÈÄöË©±ÁØÑÂõ≤ („É°„Éº„Éà„É´)</label>
                <input type="range" class="audio-slider" id="voiceRange" min="50" max="300" value="150">
            </div>
        </div>

        <!-- „Ç™„Éï„Ç£„ÇπÁ©∫Èñì -->
        <div class="office-space" id="officeSpace">
            <div class="office-floor" id="officeFloor">
                <!-- „Éá„Çπ„ÇØ„Ç®„É™„Ç¢ -->
                <div class="desk" style="top: 100px; left: 100px; width: 80px; height: 60px;">Desk 1</div>
                <div class="desk" style="top: 100px; left: 200px; width: 80px; height: 60px;">Desk 2</div>
                <div class="desk" style="top: 100px; left: 300px; width: 80px; height: 60px;">Desk 3</div>
                <div class="desk" style="top: 200px; left: 100px; width: 80px; height: 60px;">Desk 4</div>
                <div class="desk" style="top: 200px; left: 200px; width: 80px; height: 60px;">Desk 5</div>
                <div class="desk" style="top: 200px; left: 300px; width: 80px; height: 60px;">Desk 6</div>

                <!-- ‰ºöË≠∞ÂÆ§ -->
                <div class="meeting-room" style="top: 100px; right: 100px; width: 200px; height: 150px;">
                    üìã Meeting Room A
                </div>
                <div class="meeting-room" style="top: 300px; right: 100px; width: 200px; height: 150px;">
                    üíº Meeting Room B
                </div>

                <!-- „É©„Ç¶„É≥„Ç∏„Ç®„É™„Ç¢ -->
                <div class="lounge" style="bottom: 100px; left: 100px; width: 300px; height: 120px;">
                    ‚òï Coffee Lounge
                </div>

                <!-- Èü≥Â£∞ÁØÑÂõ≤Ë°®Á§∫ -->
                <div class="voice-range" id="voiceRange"></div>
            </div>
        </div>

        <!-- ÂèÇÂä†ËÄÖ„Éë„Éç„É´ -->
        <div class="participants-panel">
            <div class="panel-header">
                üé§ ÂèÇÂä†ËÄÖ (<span id="participantCount">0</span>‰∫∫)
            </div>
            <div id="participantsList"></div>
        </div>

        <!-- „Ç∫„Éº„É†„Éª„Éë„É≥„Ç≥„É≥„Éà„É≠„Éº„É´ -->
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoomInBtn">+</button>
            <button class="zoom-btn" id="zoomOutBtn">-</button>
            <button class="zoom-btn" id="resetViewBtn">‚åÇ</button>
        </div>
    </div>

    <!-- Èö†„Çå„ÅüÈü≥Â£∞Ë¶ÅÁ¥† -->
    <div id="audioElements"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyABTIK8Xwj0fcdWL2T7Z2le9_UDoXdu10U",
            authDomain: "virtual-office-team.firebaseapp.com",
            databaseURL: "https://virtual-office-team-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "virtual-office-team",
            storageBucket: "virtual-office-team.firebasestorage.app",
            messagingSenderId: "904879677778",
            appId: "1:904879677778:web:ac4c511b383b02c4b35a8b"
        };

        // FirebaseÂàùÊúüÂåñ
        let database = null;
        let isFirebaseEnabled = false;

        if (firebaseConfig.apiKey !== "your-api-key-here") {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseEnabled = true;
                console.log('FirebaseÊé•Á∂öÊàêÂäü - „É™„Ç¢„É´„Çø„Ç§„É†Èü≥Â£∞ÈÄöË©±„ÅåÂà©Áî®ÂèØËÉΩ');
            } catch (error) {
                console.log('FirebaseÊé•Á∂öÂ§±Êïó„ÄÅ„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„ÅßÂãï‰Ωú:', error);
            }
        }

        // Èü≥Â£∞Èñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let localStream = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;
        let isMicOn = false;
        let masterVolume = 0.5;
        let micSensitivity = 0.5;
        let voiceRangeDistance = 150;
        let isAudioInitialized = false;
        let peerConnections = {};
        let remoteStreams = {};

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Áä∂ÊÖã
        let currentUser = null;
        let users = {};
        let currentStatus = 'available';
        let currentZoom = 1;
        let panX = 0;
        let panY = 0;

        // DOMË¶ÅÁ¥†
        const elements = {
            entryScreen: document.getElementById('entryScreen'),
            officeContainer: document.getElementById('officeContainer'),
            loadingScreen: document.getElementById('loadingScreen'),
            nicknameInput: document.getElementById('nicknameInput'),
            charCount: document.getElementById('charCount'),
            joinBtn: document.getElementById('joinBtn'),
            userAvatarHeader: document.getElementById('userAvatarHeader'),
            userNameHeader: document.getElementById('userNameHeader'),
            statusBtn: document.getElementById('statusBtn'),
            micBtn: document.getElementById('micBtn'),
            volumeBtn: document.getElementById('volumeBtn'),
            leaveBtn: document.getElementById('leaveBtn'),
            officeSpace: document.getElementById('officeSpace'),
            officeFloor: document.getElementById('officeFloor'),
            participantCount: document.getElementById('participantCount'),
            participantsList: document.getElementById('participantsList'),
            zoomInBtn: document.getElementById('zoomInBtn'),
            zoomOutBtn: document.getElementById('zoomOutBtn'),
            resetViewBtn: document.getElementById('resetViewBtn'),
            micIndicator: document.getElementById('micIndicator'),
            audioLevelFill: document.getElementById('audioLevelFill'),
            audioSettings: document.getElementById('audioSettings'),
            micSensitivity: document.getElementById('micSensitivity'),
            masterVolume: document.getElementById('masterVolume'),
            voiceRange: document.getElementById('voiceRange'),
            voiceRangeSlider: document.getElementById('voiceRange'),
            audioElements: document.getElementById('audioElements')
        };

        // Èü≥Â£∞ÂàùÊúüÂåñ
        async function initializeAudio() {
            try {
                showLoading();
                
                // „Éû„Ç§„ÇØ„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    }
                });

                // Èü≥Â£∞ÂàÜÊûê„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(localStream);
                
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                microphone.connect(analyser);
                
                isMicOn = true;
                isAudioInitialized = true;
                
                console.log('Èü≥Â£∞„Éá„Éê„Ç§„ÇπÂàùÊúüÂåñÊàêÂäü');
                showNotification('üé§ Èü≥Â£∞„Éá„Éê„Ç§„Çπ„ÅåÊ∫ñÂÇô„Åß„Åç„Åæ„Åó„ÅüÔºÅ');
                
                // Èü≥Â£∞„É¨„Éô„É´Áõ£Ë¶ñÈñãÂßã
                startAudioLevelMonitoring();
                
                hideLoading();
                return true;
                
            } catch (error) {
                console.error('Èü≥Â£∞„Éá„Éê„Ç§„ÇπÂàùÊúüÂåñÂ§±Êïó:', error);
                showNotification('‚ùå „Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                hideLoading();
                return false;
            }
        }

        // Èü≥Â£∞„É¨„Éô„É´Áõ£Ë¶ñ
        function startAudioLevelMonitoring() {
            if (!analyser || !dataArray) return;
            
            function updateAudioLevel() {
                analyser.getByteFrequencyData(dataArray);
                
                // Èü≥Â£∞„É¨„Éô„É´Ë®àÁÆó
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                const average = sum / dataArray.length;
                const level = Math.min(100, (average / 255) * 100 * (micSensitivity * 2));
                
                // UIÊõ¥Êñ∞
                elements.audioLevelFill.style.width = level + '%';
                
                // Ë©±„Åó‰∏≠Âà§ÂÆö
                const isSpeaking = level > 10;
                updateSpeakingState(isSpeaking);
                
                // Ëá™ÂàÜ„ÅÆÈü≥Â£∞„É¨„Éô„É´„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Å´ÈÄÅ‰ø°
                if (currentUser && isFirebaseEnabled) {
                    database.ref(`users/${currentUser.id}`).update({
                        audioLevel: level,
                        isSpeaking: isSpeaking
                    });
                }
                
                requestAnimationFrame(updateAudioLevel);
            }
            
            updateAudioLevel();
        }

        // Ë©±„Åó‰∏≠Áä∂ÊÖãÊõ¥Êñ∞
        function updateSpeakingState(isSpeaking) {
            elements.micIndicator.classList.toggle('speaking', isSpeaking && isMicOn);
            elements.micBtn.classList.toggle('speaking', isSpeaking && isMicOn);
            
            const myAvatar = elements.officeFloor.querySelector(`[data-user-id="${currentUser?.id}"]`);
            if (myAvatar) {
                const circle = myAvatar.querySelector('.avatar-circle');
                const micIndicator = myAvatar.querySelector('.avatar-mic-indicator');
                if (circle) circle.classList.toggle('speaking', isSpeaking && isMicOn);
                if (micIndicator) micIndicator.classList.toggle('speaking', isSpeaking && isMicOn);
            }
        }

        // Á©∫ÈñìÈü≥Â£∞„Ç∑„Çπ„ÉÜ„É†
        function calculateSpatialAudio(userId) {
            if (!users[userId] || !currentUser) return;
            
            const user = users[userId];
            const distance = Math.sqrt(
                Math.pow(user.x - currentUser.x, 2) + 
                Math.pow(user.y - currentUser.y, 2)
            );
            
            // Ë∑ùÈõ¢„Å´Âü∫„Å•„ÅèÈü≥ÈáèË™øÊï¥
            const maxDistance = voiceRangeDistance;
            let volume = 0;
            
            if (distance < maxDistance) {
                volume = Math.pow(1 - (distance / maxDistance), 1.5);
            }
            
            const finalVolume = Math.max(0, Math.min(1, volume * masterVolume));
            
            // Èü≥Â£∞Ë¶ÅÁ¥†„ÅÆÈü≥Èáè„ÇíË™øÊï¥
            const audioElement = document.getElementById(`audio-${userId}`);
            if (audioElement) {
                audioElement.volume = finalVolume;
            }
            
            return finalVolume;
        }

        // „É™„É¢„Éº„ÉàÈü≥Â£∞„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        function setupRemoteAudio(userId, stream) {
            // Êó¢Â≠ò„ÅÆÈü≥Â£∞Ë¶ÅÁ¥†„ÇíÂâäÈô§
            const existingAudio = document.getElementById(`audio-${userId}`);
            if (existingAudio) {
                existingAudio.remove();
            }
            
            // Êñ∞„Åó„ÅÑÈü≥Â£∞Ë¶ÅÁ¥†„Çí‰ΩúÊàê
            const audio = document.createElement('audio');
            audio.id = `audio-${userId}`;
            audio.srcObject = stream;
            audio.autoplay = true;
            audio.volume = masterVolume;
            
            elements.audioElements.appendChild(audio);
            
            // ÂàùÊúüÈü≥ÈáèË®≠ÂÆö
            calculateSpatialAudio(userId);
            
            console.log(`${userId}„ÅÆÈü≥Â£∞„Çπ„Éà„É™„Éº„É†„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü`);
        }

        // WebRTCÊé•Á∂ö„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        async function setupWebRTC(remoteUserId) {
            if (!isFirebaseEnabled) return;
            
            const peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });
            
            peerConnections[remoteUserId] = peerConnection;
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É™„Éº„É†ËøΩÂä†
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // „É™„É¢„Éº„Éà„Çπ„Éà„É™„Éº„É†Âèó‰ø°
            peerConnection.ontrack = (event) => {
                const remoteStream = event.streams[0];
                remoteStreams[remoteUserId] = remoteStream;
                setupRemoteAudio(remoteUserId, remoteStream);
                showNotification(`üé§ ${users[remoteUserId]?.nickname || '„É¶„Éº„Ç∂„Éº'}„Å®Èü≥Â£∞Êé•Á∂ö„Åó„Åæ„Åó„Åü`);
            };
            
            // ICEÂÄôË£ú„ÅÆÂá¶ÁêÜ
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    database.ref(`webrtc/${currentUser.id}/${remoteUserId}/candidates`).push({
                        candidate: event.candidate,
                        timestamp: Date.now()
                    });
                }
            };
            
            return peerConnection;
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getRandomColor() {
            const colors = [
                'linear-gradient(135deg, #3b82f6, #1d4ed8)',
                'linear-gradient(135deg, #10b981, #059669)',
                'linear-gradient(135deg, #f59e0b, #d97706)',
                'linear-gradient(135deg, #ef4444, #dc2626)',
                'linear-gradient(135deg, #8b5cf6, #7c3aed)',
                'linear-gradient(135deg, #06b6d4, #0891b2)'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupEventListeners() {
            // „Éã„ÉÉ„ÇØ„Éç„Éº„É†ÂÖ•Âäõ
            elements.nicknameInput.addEventListener('input', updateCharCount);
            elements.nicknameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !elements.joinBtn.disabled) {
                    joinOffice();
                }
            });

            // ÂèÇÂä†„Éú„Çø„É≥
            elements.joinBtn.addEventListener('click', joinOffice);

            // „Ç≥„É≥„Éà„É≠„Éº„É´
            elements.statusBtn.addEventListener('click', toggleStatus);
            elements.micBtn.addEventListener('click', toggleMic);
            elements.volumeBtn.addEventListener('click', toggleAudioSettings);
            elements.leaveBtn.addEventListener('click', leaveOffice);

            // „Ç™„Éï„Ç£„ÇπÂÜÖÁßªÂãï
            elements.officeFloor.addEventListener('click', moveToPosition);

            // „Ç∫„Éº„É†„Éª„Éë„É≥„Ç≥„É≥„Éà„É≠„Éº„É´
            elements.zoomInBtn.addEventListener('click', () => zoomOffice(1.2));
            elements.zoomOutBtn.addEventListener('click', () => zoomOffice(0.8));
            elements.resetViewBtn.addEventListener('click', resetView);

            // „Éû„Ç¶„Çπ„Éõ„Ç§„Éº„É´„Åß„Ç∫„Éº„É†
            elements.officeSpace.addEventListener('wheel', handleWheel);

            // Èü≥Â£∞Ë®≠ÂÆö
            elements.micSensitivity.addEventListener('input', (e) => {
                micSensitivity = e.target.value / 100;
            });
            
            elements.masterVolume.addEventListener('input', (e) => {
                masterVolume = e.target.value / 100;
                updateAllAudioVolumes();
            });
            
            elements.voiceRangeSlider.addEventListener('input', (e) => {
                voiceRangeDistance = parseInt(e.target.value);
                updateVoiceRangeDisplay();
            });

            // „Éâ„É©„ÉÉ„Ç∞„Åß„Éë„É≥
            let isDragging = false;
            let lastX, lastY;

            elements.officeSpace.addEventListener('mousedown', (e) => {
                if (e.target === elements.officeSpace || e.target === elements.officeFloor) {
                    isDragging = true;
                    lastX = e.clientX;
                    lastY = e.clientY;
                    elements.officeSpace.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - lastX;
                    const deltaY = e.clientY - lastY;
                    panX += deltaX;
                    panY += deltaY;
                    updateTransform();
                    lastX = e.clientX;
                    lastY = e.clientY;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    elements.officeSpace.style.cursor = 'move';
                }
            });
        }

        // ÂÖ®Èü≥Â£∞Èü≥ÈáèÊõ¥Êñ∞
        function updateAllAudioVolumes() {
            Object.keys(users).forEach(userId => {
                if (userId !== currentUser?.id) {
                    calculateSpatialAudio(userId);
                }
            });
        }

        // Èü≥Â£∞ÁØÑÂõ≤Ë°®Á§∫Êõ¥Êñ∞
        function updateVoiceRangeDisplay() {
            if (!currentUser) return;
            
            const range = elements.voiceRange;
            const diameter = voiceRangeDistance * 2;
            
            range.style.width = diameter + 'px';
            range.style.height = diameter + 'px';
            range.style.left = (currentUser.x - voiceRangeDistance + 25) + 'px';
            range.style.top = (currentUser.y - voiceRangeDistance + 25) + 'px';
        }

        // ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
        function updateCharCount() {
            const length = elements.nicknameInput.value.length;
            elements.charCount.textContent = length;
            elements.joinBtn.disabled = length === 0 || length > 10;
        }

        // „Ç™„Éï„Ç£„ÇπÂèÇÂä†
        async function joinOffice() {
            const nickname = elements.nicknameInput.value.trim();
            if (!nickname || nickname.length > 10) {
                alert('ÂêçÂâç„ÅØ1-10ÊñáÂ≠ó„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // Èü≥Â£∞ÂàùÊúüÂåñ
            const audioSuccess = await initializeAudio();
            if (!audioSuccess) {
                alert('Èü≥Â£∞„Éá„Éê„Ç§„Çπ„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éû„Ç§„ÇØ„ÅÆË®±ÂèØ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            try {
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±‰ΩúÊàê
                const userId = generateUserId();
                currentUser = {
                    id: userId,
                    nickname: nickname,
                    x: 500 + Math.random() * 200,
                    y: 300 + Math.random() * 200,
                    status: 'available',
                    micOn: true,
                    color: getRandomColor(),
                    joinedAt: Date.now(),
                    audioLevel: 0,
                    isSpeaking: false
                };

                // Firebase„Åæ„Åü„ÅØ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                if (isFirebaseEnabled) {
                    await database.ref(`users/${userId}`).set({
                        ...currentUser,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    showNotification('üéâ Èü≥Â£∞ÈÄöË©±ÂØæÂøú„Éê„Éº„ÉÅ„É£„É´„Ç™„Éï„Ç£„Çπ„Å´ÂèÇÂä†„Åó„Åæ„Åó„ÅüÔºÅ');
                } else {
                    users[userId] = currentUser;
                    addDemoUsers();
                    showNotification('üéØ „Éá„É¢„É¢„Éº„Éâ„ÅßÈü≥Â£∞ÈÄöË©±„Çí„ÉÜ„Çπ„Éà„Åß„Åç„Åæ„Åô');
                }

                showOffice();
                startRealtimeUpdates();
                updateVoiceRangeDisplay();

            } catch (error) {
                console.error('ÂèÇÂä†„Ç®„É©„Éº:', error);
                alert('„Ç™„Éï„Ç£„Çπ„Å∏„ÅÆÂèÇÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                hideLoading();
            }
        }

        // „Éá„É¢„É¶„Éº„Ç∂„ÉºËøΩÂä†
        function addDemoUsers() {
            const demoUsers = [
                { nickname: 'AI Assistant', status: 'available', x: 300, y: 200 },
                { nickname: 'Team Lead', status: 'meeting', x: 800, y: 350 },
                { nickname: 'Designer', status: 'focus', x: 600, y: 500 }
            ];

            demoUsers.forEach((demo, index) => {
                const demoId = 'demo_' + index;
                users[demoId] = {
                    id: demoId,
                    nickname: demo.nickname,
                    x: demo.x,
                    y: demo.y,
                    status: demo.status,
                    micOn: Math.random() > 0.3,
                    color: getRandomColor(),
                    joinedAt: Date.now() - Math.random() * 60000,
                    audioLevel: Math.random() * 50,
                    isSpeaking: Math.random() > 0.7
                };
            });

            updateUserDisplay();
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞ÈñãÂßã
        function startRealtimeUpdates() {
            if (isFirebaseEnabled) {
                const usersRef = database.ref('users');
                
                // „É¶„Éº„Ç∂„Éº‰∏ÄË¶ßÁõ£Ë¶ñ
                usersRef.on('value', (snapshot) => {
                    const newUsers = snapshot.val() || {};
                    const previousUsers = { ...users };
                    
                    // Êñ∞Ë¶è„É¶„Éº„Ç∂„Éº„ÅÆWebRTCÊé•Á∂öÈñãÂßã
                    Object.keys(newUsers).forEach(userId => {
                        if (userId !== currentUser.id && !previousUsers[userId] && !peerConnections[userId]) {
                            console.log(`Êñ∞„Åó„ÅÑ„É¶„Éº„Ç∂„Éº ${userId} „ÅåÂèÇÂä†„Åó„Åæ„Åó„Åü`);
                            setTimeout(() => {
                                setupWebRTC(userId);
                            }, 1000);
                        }
                    });
                    
                    // ÈÄÄÂá∫„É¶„Éº„Ç∂„Éº„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                    Object.keys(previousUsers).forEach(userId => {
                        if (!newUsers[userId] && userId !== currentUser.id) {
                            console.log(`„É¶„Éº„Ç∂„Éº ${userId} „ÅåÈÄÄÂá∫„Åó„Åæ„Åó„Åü`);
                            cleanupPeerConnection(userId);
                        }
                    });
                    
                    users = newUsers;
                    updateUserDisplay();
                    updateAllAudioVolumes();
                });

                // ÂÆöÊúüÁöÑ„Å´„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÊõ¥Êñ∞
                setInterval(() => {
                    if (currentUser) {
                        database.ref(`users/${currentUser.id}`).update({
                            lastActive: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                }, 30000);
            } else {
                // „Éá„É¢„É¢„Éº„ÉâÁî®„ÅÆÈü≥Â£∞„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
                setInterval(() => {
                    Object.keys(users).forEach(userId => {
                        if (userId !== currentUser?.id) {
                            users[userId].audioLevel = Math.random() * 30;
                            users[userId].isSpeaking = Math.random() > 0.8;
                        }
                    });
                    updateUserDisplay();
                }, 2000);
            }
        }

        // PeerConnection „ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        function cleanupPeerConnection(userId) {
            if (peerConnections[userId]) {
                peerConnections[userId].close();
                delete peerConnections[userId];
            }
            if (remoteStreams[userId]) {
                delete remoteStreams[userId];
            }
            const audioElement = document.getElementById(`audio-${userId}`);
            if (audioElement) {
                audioElement.remove();
            }
            showNotification(`üëã ${users[userId]?.nickname || '„É¶„Éº„Ç∂„Éº'}„ÅåÈÄÄÂá∫„Åó„Åæ„Åó„Åü`);
        }

        // „É¶„Éº„Ç∂„ÉºË°®Á§∫Êõ¥Êñ∞
        function updateUserDisplay() {
            // Êó¢Â≠ò„ÅÆ„Ç¢„Éê„Çø„Éº„ÇíÂâäÈô§
            const existingAvatars = elements.officeFloor.querySelectorAll('.user-avatar');
            existingAvatars.forEach(avatar => avatar.remove());

            // „É¶„Éº„Ç∂„Éº„Ç¢„Éê„Çø„Éº‰ΩúÊàê
            Object.values(users).forEach(user => {
                createUserAvatar(user);
            });

            // ÂèÇÂä†ËÄÖ„É™„Çπ„ÉàÊõ¥Êñ∞
            updateParticipantsList();
        }

        // „É¶„Éº„Ç∂„Éº„Ç¢„Éê„Çø„Éº‰ΩúÊàê
        function createUserAvatar(user) {
            const avatar = document.createElement('div');
            avatar.className = 'user-avatar';
            if (user.id === currentUser?.id) {
                avatar.classList.add('joining');
            }
            avatar.style.left = user.x + 'px';
            avatar.style.top = user.y + 'px';
            avatar.setAttribute('data-user-id', user.id);

            const circle = document.createElement('div');
            circle.className = 'avatar-circle';
            if (user.id === currentUser?.id) {
                circle.classList.add('my-avatar');
            }
            if (user.isSpeaking && user.micOn) {
                circle.classList.add('speaking');
            }
            circle.style.background = user.color;
            circle.textContent = user.nickname.charAt(0).toUpperCase();

            const statusIndicator = document.createElement('div');
            statusIndicator.className = `status-indicator status-${user.status}`;

            const micIndicator = document.createElement('div');
            micIndicator.className = 'avatar-mic-indicator';
            if (!user.micOn) {
                micIndicator.classList.add('muted');
            }
            if (user.isSpeaking && user.micOn) {
                micIndicator.classList.add('speaking');
            }

            const name = document.createElement('div');
            name.className = 'avatar-name';
            name.textContent = user.nickname;

            circle.appendChild(statusIndicator);
            circle.appendChild(micIndicator);
            avatar.appendChild(circle);
            avatar.appendChild(name);

            elements.officeFloor.appendChild(avatar);
        }

        // ÂèÇÂä†ËÄÖ„É™„Çπ„ÉàÊõ¥Êñ∞
        function updateParticipantsList() {
            const userCount = Object.keys(users).length;
            elements.participantCount.textContent = userCount;

            elements.participantsList.innerHTML = '';
            Object.values(users).forEach(user => {
                const item = document.createElement('div');
                item.className = 'participant-item';

                const avatar = document.createElement('div');
                avatar.className = 'participant-avatar';
                avatar.style.background = user.color;
                avatar.textContent = user.nickname.charAt(0).toUpperCase();

                const statusIndicator = document.createElement('div');
                statusIndicator.className = `status-indicator status-${user.status}`;
                avatar.appendChild(statusIndicator);

                const micIndicator = document.createElement('div');
                micIndicator.className = 'avatar-mic-indicator';
                if (!user.micOn) {
                    micIndicator.classList.add('muted');
                }
                if (user.isSpeaking && user.micOn) {
                    micIndicator.classList.add('speaking');
                }
                avatar.appendChild(micIndicator);

                const info = document.createElement('div');
                info.className = 'participant-info';

                const name = document.createElement('p');
                name.className = 'participant-name';
                name.textContent = user.nickname;

                const status = document.createElement('p');
                status.className = 'participant-status';
                status.textContent = getStatusText(user.status);

                const volumeBar = document.createElement('div');
                volumeBar.className = 'participant-volume';
                const volumeFill = document.createElement('div');
                volumeFill.className = 'participant-volume-fill';
                volumeFill.style.width = (user.audioLevel || 0) + '%';
                volumeBar.appendChild(volumeFill);

                info.appendChild(name);
                info.appendChild(status);
                info.appendChild(volumeBar);

                item.appendChild(avatar);
                item.appendChild(info);
                elements.participantsList.appendChild(item);
            });
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó
        function getStatusText(status) {
            const statusMap = {
                available: 'Âú®Â∏≠',
                away: 'Èõ¢Â∏≠',
                meeting: '„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞‰∏≠',
                focus: 'ÈõÜ‰∏≠‰∏≠'
            };
            return statusMap[status] || 'Âú®Â∏≠';
        }

        // ‰ΩçÁΩÆÁßªÂãï
        function moveToPosition(event) {
            if (!currentUser) return;

            const rect = elements.officeFloor.getBoundingClientRect();
            const x = (event.clientX - rect.left) / currentZoom - 25;
            const y = (event.clientY - rect.top) / currentZoom - 25;

            // Â¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ
            const maxX = elements.officeFloor.clientWidth - 50;
            const maxY = elements.officeFloor.clientHeight - 50;
            const finalX = Math.max(0, Math.min(x, maxX));
            const finalY = Math.max(0, Math.min(y, maxY));

            currentUser.x = finalX;
            currentUser.y = finalY;
            users[currentUser.id] = { ...currentUser };

            // Ëá™ÂàÜ„ÅÆ„Ç¢„Éê„Çø„ÉºÊõ¥Êñ∞
            const myAvatar = elements.officeFloor.querySelector(`[data-user-id="${currentUser.id}"]`);
            if (myAvatar) {
                myAvatar.style.left = finalX + 'px';
                myAvatar.style.top = finalY + 'px';
            }

            // Èü≥Â£∞ÁØÑÂõ≤Ë°®Á§∫Êõ¥Êñ∞
            updateVoiceRangeDisplay();

            // Á©∫ÈñìÈü≥Â£∞Êõ¥Êñ∞
            updateAllAudioVolumes();

            // „Éá„Éº„Çø„Éô„Éº„ÇπÊõ¥Êñ∞
            if (isFirebaseEnabled) {
                database.ref(`users/${currentUser.id}`).update({
                    x: finalX,
                    y: finalY,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπÂàá„ÇäÊõø„Åà
        function toggleStatus() {
            const statuses = ['available', 'away', 'meeting', 'focus'];
            const currentIndex = statuses.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % statuses.length;
            currentStatus = statuses[nextIndex];

            const statusEmojis = {
                available: 'üü¢ Âú®Â∏≠',
                away: 'üü° Èõ¢Â∏≠',
                meeting: 'üî¥ „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞‰∏≠',
                focus: 'üü£ ÈõÜ‰∏≠‰∏≠'
            };

            const statusClasses = {
                available: '',
                away: 'away',
                meeting: 'meeting',
                focus: 'focus'
            };

            elements.statusBtn.textContent = statusEmojis[currentStatus];
            elements.statusBtn.className = `control-btn status-btn ${statusClasses[currentStatus]}`;

            if (currentUser) {
                currentUser.status = currentStatus;
                updateUserStatus();
            }
        }

        // „Éû„Ç§„ÇØÂàá„ÇäÊõø„Åà
        function toggleMic() {
            isMicOn = !isMicOn;
            elements.micBtn.textContent = isMicOn ? 'üé§ „Éû„Ç§„ÇØON' : 'üîá „Éû„Ç§„ÇØOFF';
            elements.micBtn.classList.toggle('muted', !isMicOn);
            elements.micIndicator.classList.toggle('muted', !isMicOn);

            // „Éû„Ç§„ÇØ„ÅÆÂÆüÈöõ„ÅÆÊúâÂäπ/ÁÑ°ÂäπÂåñ
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = isMicOn;
                });
            }

            if (currentUser) {
                currentUser.micOn = isMicOn;
                updateUserStatus();
            }

            const action = isMicOn ? 'ON' : 'OFF';
            showNotification(`üé§ „Éû„Ç§„ÇØ„Çí${action}„Å´„Åó„Åæ„Åó„Åü`);
        }

        // Èü≥Â£∞Ë®≠ÂÆöÂàá„ÇäÊõø„Åà
        function toggleAudioSettings() {
            elements.audioSettings.classList.toggle('show');
        }

        // „É¶„Éº„Ç∂„Éº„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        function updateUserStatus() {
            if (isFirebaseEnabled && currentUser) {
                database.ref(`users/${currentUser.id}`).update({
                    status: currentUser.status,
                    micOn: currentUser.micOn,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
            } else if (currentUser) {
                users[currentUser.id] = { ...currentUser };
                updateUserDisplay();
            }
        }

        // ÈÄöÁü•Ë°®Á§∫
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // „Ç∫„Éº„É†Ê©üËÉΩ
        function zoomOffice(factor) {
            currentZoom = Math.max(0.5, Math.min(2, currentZoom * factor));
            updateTransform();
        }

        // „Éì„É•„Éº„É™„Çª„ÉÉ„Éà
        function resetView() {
            currentZoom = 1;
            panX = 0;
            panY = 0;
            updateTransform();
        }

        // Â§âÂΩ¢Êõ¥Êñ∞
        function updateTransform() {
            elements.officeFloor.style.transform = 
                `translate(calc(-50% + ${panX}px), calc(-50% + ${panY}px)) scale(${currentZoom})`;
        }

        // „Éõ„Ç§„Éº„É´Âá¶ÁêÜ
        function handleWheel(event) {
            event.preventDefault();
            const delta = event.deltaY > 0 ? 0.9 : 1.1;
            zoomOffice(delta);
        }

        // „Ç™„Éï„Ç£„ÇπÈÄÄÂá∫
        async function leaveOffice() {
            if (confirm('„Ç™„Éï„Ç£„Çπ„Åã„ÇâÈÄÄÂá∫„Åó„Åæ„Åô„ÅãÔºü')) {
                // Èü≥Â£∞„Éá„Éê„Ç§„Çπ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                
                // WebRTCÊé•Á∂ö„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                Object.values(peerConnections).forEach(pc => pc.close());
                peerConnections = {};
                remoteStreams = {};
                
                // Èü≥Â£∞Ë¶ÅÁ¥†„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                elements.audioElements.innerHTML = '';
                
                if (isFirebaseEnabled && currentUser) {
                    await database.ref(`users/${currentUser.id}`).remove();
                }
                
                currentUser = null;
                users = {};
                hideOffice();
                showEntry();
                
                showNotification('üëã „Ç™„Éï„Ç£„Çπ„Åã„ÇâÈÄÄÂá∫„Åó„Åæ„Åó„Åü');
            }
        }

        // ÁîªÈù¢Ë°®Á§∫Âà∂Âæ°
        function showLoading() {
            elements.loadingScreen.style.display = 'flex';
        }

        function hideLoading() {
            elements.loadingScreen.style.display = 'none';
        }

        function showEntry() {
            elements.entryScreen.classList.remove('hidden');
        }

        function showOffice() {
            hideLoading();
            elements.entryScreen.classList.add('hidden');
            elements.officeContainer.style.display = 'block';

            // „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±Ë®≠ÂÆö
            elements.userAvatarHeader.textContent = currentUser.nickname.charAt(0).toUpperCase();
            elements.userAvatarHeader.style.background = currentUser.color;
            elements.userNameHeader.textContent = currentUser.nickname;
            
            // Èü≥Â£∞ÁØÑÂõ≤Ë°®Á§∫„ÇíÊúâÂäπÂåñ
            elements.voiceRange.classList.add('active');
        }

        function hideOffice() {
            elements.officeContainer.style.display = 'none';
            elements.audioSettings.classList.remove('show');
        }

        // ÂàùÊúüÂåñ
        function init() {
            setupEventListeners();
            
            // ‰øùÂ≠ò„Åï„Çå„ÅüÂêçÂâç„Åå„ÅÇ„Çå„Å∞Âæ©ÂÖÉ
            const savedName = localStorage.getItem('virtualOfficeNickname');
            if (savedName) {
                elements.nicknameInput.value = savedName;
                updateCharCount();
            }

            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´ÂêçÂâç„Çí‰øùÂ≠ò
            elements.nicknameInput.addEventListener('input', () => {
                localStorage.setItem('virtualOfficeNickname', elements.nicknameInput.value);
            });

            // „Éá„É¢„É¢„Éº„ÉâË°®Á§∫
            if (!isFirebaseEnabled) {
                setTimeout(() => {
                    const demoNotice = document.createElement('div');
                    demoNotice.style.cssText = `
                        position: fixed; top: 20px; left: 20px;
                        background: #f59e0b; color: white;
                        padding: 8px 12px; border-radius: 6px;
                        font-size: 12px; z-index: 1001;
                    `;
                    demoNotice.textContent = 'üéØ „Éá„É¢„É¢„Éº„ÉâÔºàÈü≥Â£∞„ÅØ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥Ôºâ';
                    document.body.appendChild(demoNotice);
                }, 1000);
            }
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÂßã
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
